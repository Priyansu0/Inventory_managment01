{% extends 'layout.html' %}

{% block title %}
    {% if order %}Edit Purchase Order{% else %}New Purchase Order{% endif %} - Inventory Management System
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
            <i class="bi {% if order %}bi-pencil-square{% else %}bi-plus-circle{% endif %} me-2"></i>
            {% if order %}Edit Purchase Order{% else %}Create New Purchase Order{% endif %}
        </h4>
    </div>
    <div class="card-body">
        <form method="POST" id="orderForm" class="needs-validation" novalidate>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="order_number" class="form-label">Order Number*</label>
                    <input type="text" class="form-control" id="order_number" name="order_number" 
                           value="{{ order.order_number if order else '' }}" {% if not order %}readonly{% endif %} required>
                    <div class="form-text text-muted">
                        {% if not order %}Auto-generated{% else %}Cannot be changed{% endif %}
                    </div>
                    <div class="invalid-feedback">
                        Order number is required.
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="supplier_id" class="form-label">Supplier*</label>
                    <select class="form-select" id="supplier_id" name="supplier_id" required>
                        <option value="">-- Select Supplier --</option>
                        {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" 
                                    {% if order and order.supplier_id == supplier.id %}selected{% endif %}>
                                {{ supplier.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                        Please select a supplier.
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="order_date" class="form-label">Order Date*</label>
                    <input type="date" class="form-control" id="order_date" name="order_date" 
                           value="{{ order.order_date.strftime('%Y-%m-%d') if order and order.order_date else '' }}" required>
                    <div class="invalid-feedback">
                        Please provide an order date.
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="expected_delivery" class="form-label">Expected Delivery</label>
                    <input type="date" class="form-control" id="expected_delivery" name="expected_delivery" 
                           value="{{ order.expected_delivery.strftime('%Y-%m-%d') if order and order.expected_delivery else '' }}">
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="status" class="form-label">Status*</label>
                    <select class="form-select" id="status" name="status" required>
                        <option value="pending" {% if order and order.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="ordered" {% if order and order.status == 'ordered' %}selected{% endif %}>Ordered</option>
                        <option value="partial" {% if order and order.status == 'partial' %}selected{% endif %}>Partially Received</option>
                        <option value="complete" {% if order and order.status == 'complete' %}selected{% endif %}>Complete</option>
                        <option value="cancelled" {% if order and order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2">{{ order.notes if order else '' }}</textarea>
                </div>
            </div>
            
            <!-- Order Items Section -->
            <div class="mt-4 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5>Order Items</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addItemBtn">
                        <i class="bi bi-plus-circle me-1"></i>Add Item
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered" id="itemsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if order and order.items %}
                                {% for item in order.items %}
                                    <tr data-product-id="{{ item.product_id }}">
                                        <td>{{ item.product.name }}
                                            <input type="hidden" name="product_ids[]" value="{{ item.product_id }}">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control item-quantity" name="quantities[]" 
                                                   min="1" value="{{ item.quantity }}" required>
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control item-price" name="prices[]" 
                                                       step="0.01" min="0.01" value="{{ item.unit_price }}" required>
                                            </div>
                                        </td>
                                        <td>${{ (item.quantity * item.unit_price)|round(2) }}</td>
                                        <td>
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-item">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr id="noItemsRow">
                                    <td colspan="5" class="text-center text-muted py-3">
                                        No items added yet. Click "Add Item" to add products to this order.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                        <tfoot>
                            <tr class="fw-bold">
                                <td colspan="3" class="text-end">Total:</td>
                                <td id="orderTotal">${{ order.total_amount|round(2) if order else '0.00' }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="form-text text-danger mb-3" id="itemsError" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    At least one item must be added to the order.
                </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('purchase_orders') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Cancel
                </a>
                
                <div>
                    {% if order and order.status != 'complete' %}
                        <a href="{{ url_for('receive_order', order_id=order.id) }}" class="btn btn-success me-2">
                            <i class="bi bi-box-arrow-in-down me-1"></i>Receive Items
                        </a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Save Order
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product to Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="productSelect" class="form-label">Product*</label>
                    <select class="form-select" id="productSelect" required>
                        <option value="">-- Select Product --</option>
                        {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.unit_price }}">
                                {{ product.name }} ({{ product.sku }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="itemQuantity" class="form-label">Quantity*</label>
                        <input type="number" class="form-control" id="itemQuantity" min="1" value="1" required>
                    </div>
                    <div class="col-md-6">
                        <label for="itemPrice" class="form-label">Unit Price*</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="itemPrice" 
                                   step="0.01" min="0.01" value="0.00" required>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted">Total: </span>
                        <span class="fw-bold" id="itemTotal">$0.00</span>
                    </div>
                    <div id="stockInfo" class="text-muted">
                        <!-- Stock information will appear here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddItem">Add to Order</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.getElementById('orderForm');
    const itemsTable = document.getElementById('itemsTable');
    const noItemsRow = document.getElementById('noItemsRow');
    const orderTotalEl = document.getElementById('orderTotal');
    const itemsErrorEl = document.getElementById('itemsError');
    
    // Generate order number if this is a new order
    if (!document.getElementById('order_number').value) {
        const dateString = new Date().toISOString().slice(2, 10).replace(/-/g, '');
        const randomPart = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('order_number').value = `PO-${dateString}-${randomPart}`;
    }
    
    // Set today's date as default for new orders
    if (!document.getElementById('order_date').value) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('order_date').value = today;
    }
    
    // Add Item Modal
    const addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));
    const productSelect = document.getElementById('productSelect');
    const itemQuantity = document.getElementById('itemQuantity');
    const itemPrice = document.getElementById('itemPrice');
    const itemTotal = document.getElementById('itemTotal');
    const stockInfo = document.getElementById('stockInfo');
    
    // Update item price when product is selected
    productSelect.addEventListener('change', function() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        if (selectedOption.value) {
            const price = parseFloat(selectedOption.dataset.price);
            itemPrice.value = price.toFixed(2);
            updateItemTotal();
        } else {
            itemPrice.value = '0.00';
            updateItemTotal();
        }
    });
    
    // Update item total when quantity or price changes
    itemQuantity.addEventListener('input', updateItemTotal);
    itemPrice.addEventListener('input', updateItemTotal);
    
    function updateItemTotal() {
        const quantity = parseInt(itemQuantity.value) || 0;
        const price = parseFloat(itemPrice.value) || 0;
        const total = quantity * price;
        itemTotal.textContent = `$${total.toFixed(2)}`;
    }
    
    // Show Add Item modal
    document.getElementById('addItemBtn').addEventListener('click', function() {
        // Reset form
        productSelect.value = '';
        itemQuantity.value = '1';
        itemPrice.value = '0.00';
        updateItemTotal();
        stockInfo.innerHTML = '';
        
        addItemModal.show();
    });
    
    // Add item to order
    document.getElementById('confirmAddItem').addEventListener('click', function() {
        const productId = productSelect.value;
        if (!productId) {
            alert('Please select a product');
            return;
        }
        
        const quantity = parseInt(itemQuantity.value);
        if (!quantity || quantity < 1) {
            alert('Please enter a valid quantity');
            return;
        }
        
        const price = parseFloat(itemPrice.value);
        if (!price || price <= 0) {
            alert('Please enter a valid price');
            return;
        }
        
        // Check if product already exists in the order
        const existingRow = Array.from(itemsTable.querySelectorAll('tbody tr')).find(
            row => row.dataset.productId === productId
        );
        
        if (existingRow) {
            // Update existing row
            const quantityInput = existingRow.querySelector('.item-quantity');
            const priceInput = existingRow.querySelector('.item-price');
            const totalCell = existingRow.querySelector('td:nth-child(4)');
            
            quantityInput.value = quantity;
            priceInput.value = price.toFixed(2);
            totalCell.textContent = `$${(quantity * price).toFixed(2)}`;
        } else {
            // Add new row
            if (noItemsRow) {
                noItemsRow.remove();
            }
            
            const productName = productSelect.options[productSelect.selectedIndex].text;
            const total = quantity * price;
            
            const newRow = document.createElement('tr');
            newRow.dataset.productId = productId;
            newRow.innerHTML = `
                <td>${productName}
                    <input type="hidden" name="product_ids[]" value="${productId}">
                </td>
                <td>
                    <input type="number" class="form-control item-quantity" name="quantities[]" 
                           min="1" value="${quantity}" required>
                </td>
                <td>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control item-price" name="prices[]" 
                               step="0.01" min="0.01" value="${price.toFixed(2)}" required>
                    </div>
                </td>
                <td>$${total.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-item">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            itemsTable.querySelector('tbody').appendChild(newRow);
            
            // Add event listener to the new remove button
            newRow.querySelector('.remove-item').addEventListener('click', function() {
                newRow.remove();
                updateOrderTotal();
                checkItemsExist();
            });
            
            // Add event listeners to new inputs
            const newQuantityInput = newRow.querySelector('.item-quantity');
            const newPriceInput = newRow.querySelector('.item-price');
            
            newQuantityInput.addEventListener('input', function() {
                updateRowTotal(newRow);
                updateOrderTotal();
            });
            
            newPriceInput.addEventListener('input', function() {
                updateRowTotal(newRow);
                updateOrderTotal();
            });
        }
        
        updateOrderTotal();
        addItemModal.hide();
    });
    
    // Remove item event delegation
    itemsTable.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item') || 
            e.target.parentElement.classList.contains('remove-item')) {
            const row = e.target.closest('tr');
            row.remove();
            updateOrderTotal();
            checkItemsExist();
        }
    });
    
    // Update row total when quantity or price changes
    itemsTable.addEventListener('input', function(e) {
        if (e.target.classList.contains('item-quantity') || 
            e.target.classList.contains('item-price')) {
            const row = e.target.closest('tr');
            updateRowTotal(row);
            updateOrderTotal();
        }
    });
    
    function updateRowTotal(row) {
        const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const total = quantity * price;
        row.querySelector('td:nth-child(4)').textContent = `$${total.toFixed(2)}`;
    }
    
    function updateOrderTotal() {
        let total = 0;
        const rows = itemsTable.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (!row.id || row.id !== 'noItemsRow') {
                const rowTotal = parseFloat(row.querySelector('td:nth-child(4)').textContent.replace('$', '')) || 0;
                total += rowTotal;
            }
        });
        
        orderTotalEl.textContent = `$${total.toFixed(2)}`;
    }
    
    function checkItemsExist() {
        const rows = itemsTable.querySelectorAll('tbody tr');
        if (rows.length === 0 || (rows.length === 1 && rows[0].id === 'noItemsRow')) {
            const tbody = itemsTable.querySelector('tbody');
            tbody.innerHTML = `
                <tr id="noItemsRow">
                    <td colspan="5" class="text-center text-muted py-3">
                        No items added yet. Click "Add Item" to add products to this order.
                    </td>
                </tr>
            `;
        }
    }
    
    // Form validation
    form.addEventListener('submit', function(event) {
        // Check if there are items in the order
        const hasItems = itemsTable.querySelectorAll('tbody tr:not(#noItemsRow)').length > 0;
        
        if (!hasItems) {
            event.preventDefault();
            event.stopPropagation();
            itemsErrorEl.style.display = 'block';
            return;
        } else {
            itemsErrorEl.style.display = 'none';
        }
        
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
